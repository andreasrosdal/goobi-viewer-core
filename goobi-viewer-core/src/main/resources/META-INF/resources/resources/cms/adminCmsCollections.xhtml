<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://xmlns.jcp.org/jsf/html"
	xmlns:f="http://xmlns.jcp.org/jsf/core"
	xmlns:fn="http://java.sun.com/jsp/jstl/functions"
	xmlns:p="http://primefaces.org/ui"
	xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
	xmlns:c="http://java.sun.com/jsp/jstl/core"
	xmlns:viewerComponent="http://xmlns.jcp.org/jsf/composite/components"
	xmlns:adminWidget="http://xmlns.jcp.org/jsf/composite/admin/widgets"
	template="/resources/themes/#{navigationHelper.theme}/templateAdmin.html">

	<ui:define name="metadata">
		<f:metadata>
			<f:event type="preRenderView"
				listener="#{navigationHelper.setCurrentPageAdmin('adminCmsCollections')}" />
			<f:event type="preRenderView" listener="#{cmsBean.init()}" />
			<f:event type="preRenderView"
				listener="#{browseBean.initializeCollection(cmsCollectionsBean.solrField, searchBean.facetifyField(cmsCollectionsBean.solrField))}" />
			<f:event type="preRenderView"
				listener="#{browseBean.populateCollection(cmsCollectionsBean.solrField)}" />
		</f:metadata>
	</ui:define>

	<!-- CONTENT -->
	<ui:define name="content">
		<ui:fragment id="cmsCollectionsAccessControl"
			rendered="#{userBean.user.isHasCmsPrivilege('CMS_COLLECTIONS')}">
			<div id="cmsCollections">
			
				<!-- TITLE -->
				<div class="admin__title-bar">
					<h2 class="admin__title">#{msg.admin__cms_collections}</h2>
				</div>

				<div class="admin__content-inner-content">
				
				<!-- GENERAL DESCRIPTION -->
				<div class="admin__info-text">#{msg.admin__cms_collections_desc}</div>

					<!-- COLLECTIONS TREE/FORM -->
					<h:form id="cmsCollectionsForm" prependId="false">

						<div class="admin__content-wrapper">
						
							<div class="admin__content-main -sticky">
								<h3>#{msg.admin__cms_collections_collection_tree}</h3>
                                    
								<!-- LANGUAGE TABS -->
								<div class="admin__language-tabs">
									<viewerComponent:localeSelector 
									object="#{crowdsourcingBean.selectedCampaign}"
									render="createCampaignForm:titleDataGroup"
									execute="createCampaignForm:titleDataGroup"/>
								</div>   
                                <div class="tab-content">
<!--                                 <ui:repeat value="#{navigationHelper.supportedLanguages}" var="language" varStatus="status"> -->
								<div class="admin__default-block">
								
									<ul class="admin__cms-collections-tree-listing">
										<ui:repeat var="browseDcElement" value="#{browseBean.getCollection(cmsCollectionsBean.solrField).visibleDcElements}">
											<li class="admin__cms-collections-entry admin__cms-collections-entry -level-#{browseDcElement.level}"
												style="#{navigationHelper.localeString eq 'ar' or navigationHelper.localeString eq 'iw' ? 'padding-right:' : 'padding-left:'} #{browseDcElement.level * 32}px">
												<div class="row">
													<div class="col-2 col-sm-1 collection__structure-col">
														<!-- STRUCTURE -->
														<h:panelGroup
															rendered="#{browseDcElement.hasSubelements and !browseDcElement.opensInNewWindow}">
															<div class="collection__structure text-center">
																<h:commandLink
																	action="#{browseBean.dcCollection.toggleChildren(browseDcElement)}">
																	<f:passThroughAttribute name="aria-label"
																		value="#{msg.aria_label__show_details}" />
																	<h:panelGroup
																		rendered="#{browseDcElement.hasSubelements and !browseDcElement.showSubElements}">
																		<i class="fa fa-plus-square-o" aria-hidden="true"></i>
																	</h:panelGroup>
																	<h:panelGroup
																		rendered="#{browseDcElement.hasSubelements and browseDcElement.showSubElements}">
																		<i class="fa fa-minus-square-o" aria-hidden="true"></i>
																	</h:panelGroup>
																	<f:ajax render="@form" />
																</h:commandLink>
															</div>
														</h:panelGroup>
													</div>
													<div class="col-7 col-sm-9">
														<div class="collection__title">

															<div class="row">
																<div class="col-12">
																	<!-- TITLE -->
																	<h:outputLink
																		value="#{browseBean.dcCollection.getCollectionUrl(browseDcElement)}"
																		styleClass="#{browseBean.dcCollection.isTopVisibleElement(browseDcElement) ? 'collection__top-element' : ''}">
																		<h:outputText
																			rendered="#{browseDcElement.displayNumberOfVolumes}"
																			value="#{msg[browseDcElement.label]} (#{browseDcElement.numberOfVolumes})" />
																		<h:outputText
																			rendered="#{!browseDcElement.displayNumberOfVolumes}"
																			value="#{msg[browseDcElement.label]}" />
																		<f:ajax render="@form" />
																	</h:outputLink>
																</div>
															</div>
														</div>
													</div>
													<div class="col-3 col-sm-2 admin__cms-collections-entry-end">
														<!-- TOGGLE DESCRIPTION -->
														<h:panelGroup
															rendered="#{msg[browseDcElement.description] != browseDcElement.description || browseDcElement.hasCMSDescription()}">
															<div class="collection__description-toggle">
																<h:commandLink title="#{msg[browseDcElement.label]}">
																	<h:panelGroup
																		rendered="#{not browseDcElement.showDescription}">
																		<i class="fa fa-angle-down" aria-hidden="true"></i>
																	</h:panelGroup>

																	<h:panelGroup
																		rendered="#{browseDcElement.showDescription}">
																		<i class="fa fa-angle-up" aria-hidden="true"></i>
																	</h:panelGroup>

																	<f:setPropertyActionListener
																		target="#{browseDcElement.showDescription}"
																		value="#{not browseDcElement.showDescription}" />
																	<f:ajax render="@form" />
																</h:commandLink>
															</div>
														</h:panelGroup>

														<!-- TODO: EDIT -->
                                                			<a href="#{navigationHelper.applicationUrl}admin/cms/collections/edit/#{browseDcElement.name}/"
                                                				class="admin__cms-collections-entry-edit"
                                                				aria-label="#{msg.edit}: #{browseDcElement.name}">#{msg.edit}</a>
													</div>

													<!-- DESCRIPTION -->
													<h:panelGroup rendered="#{browseDcElement.showDescription}">
														<div class="col-12 col-sm-11 col-sm-offset-1">
															<div class="collection__description">
																<h:outputText
																	value="#{msg[browseDcElement.description]}"
																	escape="false" />
															</div>
															<h:panelGroup rendered="#{browseDcElement.hasIcon()}">
																<img data-src="#{browseDcElement.icon}" alt=""
																	class="img-fluid" data-viewer-thumbnail="thumbnail" />
															</h:panelGroup>
														</div>
													</h:panelGroup>
												</div>

											</li>
										</ui:repeat>
									</ul>
								</div>
<!-- 								</ui:repeat> -->
								</div>
							</div>


							<!-- SIDEBAR -->
							<div class="admin__content-side -sticky">

							<!-- TRANSLATIONS -->
								<c:choose>
									<c:when test="#{adminBean.hasAccessPermissingForTranslationFiles()}">
											<ui:repeat var="group"
												value="#{adminBean.getTranslationGroupsForSolrField(cmsCollectionsBean.solrField)}">
												<div class="admin__default-block -warning">
	
													<!-- GROUP TITLE -->
													<h3>#{msg.admin__cms_collections_translation}</h3>

													<!-- DESCRIPTION AVAILABLE -->
													<ui:fragment rendered="#{group.description ne ''}">
														<div class="admin__form-help-text in mb-2">
															#{msg[group.description]}
														</div>
													</ui:fragment>
													
													<!-- NO DESCRIPTION AVAILABLE -->
													<ui:fragment rendered="#{group.description eq ''}">
														<div class="admin__form-help-text in mb-2"
															aria-disabled="true">
															(#{msg.admin__label__no_description_available})</div>
													</ui:fragment>
													
													<!-- PROGRESS BAR FOR COLLECTION NAMES-->
													<div class="admin__cms-collections-progress-bar-wrapper mb-4">
													
														<div class="row no-gutters admin__cms-collections-progress-bar-info">
			                                                <div class="col-8">
			                                                	#{msg.progress}
			                                                </div>
															<div class="col-4 d-flex justify-content-end mb-1">
																<span>(#{group.fullyTranslatedEntryCount} #{msg.of} #{group.entryCount})</span>
															</div>
														</div>
		                                                    
			                                        	<div class="admin__cms-collections-progress-bar">
															<div class="admin__dashboard-translations-progress-complete"
																style="flex: 0 0 #{group.fullyTranslatedEntryCountPercentage}%; max-width: #{group.fullyTranslatedEntryCountPercentage}%;"></div>
															<div class="admin__dashboard-translations-progress-partially"
																style="flex: 0 0 #{group.partiallyTranslatedEntryCountPercentage}%; max-width: #{group.partiallyTranslatedEntryCountPercentage}%;"></div>
														</div>
													
													</div>
													
													<!-- TRANSLATION ACTION -->
													<div class="row">
														<div class="col-12 d-flex justify-content-center">
															<!-- TRANSLATIONS INCOMPLETE - SHOW TRANSLATE BUTTON -->
															<ui:fragment
																rendered="#{group.fullyTranslatedEntryCount != group.entryCount}">
																<a class="btn btn--full"
																	href="#{navigationHelper.applicationUrl}admin/translations/edit/#{group.id}/"
																	aria-label="#{msg.edit}: #{msg[group.name]}">#{msg.admin__translations_translate}</a>
	
															</ui:fragment>
			
															<!-- TRANSLATIONS COMPLETE - SHOW GO TO TRANSLATIONS BUTTON -->
															<ui:fragment
																rendered="#{group.fullyTranslatedEntryCount == group.entryCount}">
																<a class="btn btn--default"
																	href="#{navigationHelper.applicationUrl}admin/translations/edit/#{group.id}/"
																	aria-label="#{msg.edit}: #{msg[group.name]}">#{msg.show}</a>
															</ui:fragment>
														</div>
													</div>
												</div>
											</ui:repeat>
									</c:when>
									<c:otherwise>
										<div class="admin__boxed-entry -danger">
											<h3>#{msg.admin__translations__missing_write_permissions__title}</h3>
											<h:outputText escape="false"
												value="#{msg.admin__translations__missing_write_permissions__description}"></h:outputText>
										</div>
									</c:otherwise>
								</c:choose>

								<!-- COLLECTION INDEX FIELD -->
								<div class="admin__default-block">
<!-- 							<div class="#{fn:length(cmsCollectionsBean.allCollectionFields) > 1 ? '' : 'd-none'} form-group form-row"> -->
									<h3>#{msg.admin__cms_collections_solr_field}:</h3>
									<div class="admin__form-help-text in mb-4">
										#{msg.admin__cms_collections_solr_field_desc}
									</div>
									
									<div class="d-flex">
										<h:selectOneMenu id="SolrFieldSelect" name="SolrFieldSelect"
											value="#{cmsCollectionsBean.solrField}"
											styleClass="form-control">
											<f:selectItems
												value="#{cmsCollectionsBean.allCollectionFields}" />
											<f:ajax render="@form"></f:ajax>
										</h:selectOneMenu>
									</div>
								</div>
								
								<!--TODO: PREVIEW -->
								<div class="admin__default-block">
									<h3>#{msg.admin__cms_collections_preview}:</h3>
									<div class="admin__form-help-text in mb-4">
										#{msg.admin__cms_collections_preview_description}
									</div>
									<div class="row">
										<div class="col-12 d-flex justify-content-center">
				                             <h:commandLink styleClass="btn btn--default">
				                                 <h:outputText value="#{msg.preview}" />
				                                 <f:setPropertyActionListener target="#{navigationHelper.localeString}" value="#{lang}" />
				                             </h:commandLink>
			                             </div>
									</div>
								</div>

							</div>

						</div>
					</h:form>
				</div>
			</div>
		</ui:fragment>

	</ui:define>
</ui:composition>

