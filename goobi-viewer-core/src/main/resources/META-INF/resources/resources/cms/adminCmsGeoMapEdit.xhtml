<ui:composition 
    xmlns="http://www.w3.org/1999/xhtml" 
    xmlns:h="http://xmlns.jcp.org/jsf/html" 
    xmlns:f="http://xmlns.jcp.org/jsf/core" 
    xmlns:p="http://primefaces.org/ui"
    xmlns:ui="http://xmlns.jcp.org/jsf/facelets" 
    xmlns:c="http://java.sun.com/jsp/jstl/core" 
    xmlns:viewerComponent="http://xmlns.jcp.org/jsf/composite/components"
    xmlns:adminWidget="http://xmlns.jcp.org/jsf/composite/admin/widgets" 
    template="/resources/themes/#{navigationHelper.theme}/templateAdmin.html">

    <ui:define name="metadata">
        <f:metadata>
            <f:event type="preRenderView" listener="#{navigationHelper.setCurrentPageAdmin('adminCmsGeoMaps')}" />
        </f:metadata>
    </ui:define>

    <!-- CONTENT -->
    <ui:define name="content">
    
                      	<script>
					            		
					            		let currentFeature = undefined;
					            		let displayLanguage = "#{navigationHelper.localeString}";
					            		let deleteListener = new Rx.Subject();
				            		    let updateListener = new Rx.Subject();
					            		let metadataProvider = new Rx.Subject();
					            		
					            		let geoMap = new viewerJS.GeoMap({
					            		    language: displayLanguage,
					            		    popover: "#geoMapPopoverTemplate",
					            		    emptyMarkerMessage: "#{msg.request__insert_metadata}"
					            		});
					            		geoMap.onMapClick.subscribe((geojson) => {
					            		    console.log("click at ", geojson);
					            		    currentFeature = geojson;
					            		    geoMap.addMarker(geojson).openPopup();
					            		    updateMetadata(geojson);
					            		})
					            		geoMap.onFeatureMoved.subscribe((geojson) => {
					            		    console.log("moved ", geojson);
					            		})
					            		geoMap.onFeatureClick.subscribe((geojson) => {
					            		    console.log("click on ", geojson);
					            		    console.log("current Feature", currentFeature);
					            		    if(currentFeature == geojson) {
					            		        currentFeature = undefined;
					            		        updateMetadata();
					            		    } else {		
					            		        currentFeature = geojson;
					            		    	updateMetadata(geojson);
					            		    }
					            		})
				            		    
					            		deleteListener.subscribe(() => {
					            		    if(currentFeature) {
					            		        geoMap.removeMarker(currentFeature);
					            		        currentFeature = undefined;
					            		        updateMetadata();
					            		        $("#featuresInput").val(JSON.stringify(geoMap.getFeatures()));
					            		    }
					            		})
					            		updateListener.pipe(RxOp.debounceTime(100)).subscribe((metadata) => {
					            		    if(currentFeature) {					            		        
					            		        currentFeature.properties[metadata.property] = metadata.value;
					            		        geoMap.updateMarker(currentFeature.id);
					            		        $("#featuresInput").val(JSON.stringify(geoMap.getFeatures()));
					            		    }
				            		    })
					            		
					            		init = function() {
						            		let features = JSON.parse($("#featuresInput").val())
						            		console.log("load features ", features);
						            		geoMap.init();
						            		features.forEach( feature => {
						            		    geoMap.addMarker(feature);
						            		})
						            		
						            		riot.mount("metadataEditor", {
						            		    languages: #{navigationHelper.supportedLanguagesAsJson},
						            		    metadata: undefined,
						            		    provider: metadataProvider,
						            		    currentLanguage: displayLanguage,
						            		    updateListener: updateListener,
						            		    deleteListener : deleteListener,
						            		    deleteLabel : "#{msg.delete}"
						            		});
					            		}
					            		
					            		updateMetadata = function(geojson) {
					            		    let metadataList = [
					            		        {	
					            		    		property: "title",
					            		    		tyle: "text",
					            		    		label: "#{msg.title}",
					            		    		value: geojson ? geojson.properties.title : "",
					            		    		required: false,
					            		    		helptext: "#{msg.cms__geo_maps__feature_title__help}",
					            		    		editable: geojson != undefined
					            		    	},
					            		    	{	
					            		    		property: "description",
					            		    		type:"longtext",
					            		    		label: "#{msg.description}",
					            		    		value: geojson ? geojson.properties.description: "",
					            		    		required: false,
					            		    		helptext: "#{msg.cms__geo_maps__feature_description__help}",
					            		    		editable: geojson != undefined
					            		    	}
					            		    ]
					 		           		metadataProvider.next(metadataList, true);
					            		    if(geojson) {
						            		    $("html, body").scrollTop($("#featureForm").offset().top)
					            		    }
					            		}
					            		
					     </script>
    
    
        <ui:fragment id="cmsGeoMaps" rendered="#{configurationBean.cmsEnabled and userBean.user.isHasCmsPrivilege('CMS_GEOMAPS')}">
            <div id="cmsGeoMaps">
                <h2 class="admin__content-inner-title">#{msg.cms__geo_maps__title}
                </h2>
                <div class="admin__content-inner-content">
                    <h:form id="geoMapEditForm" prependId="false">
                        <h3>#{msg.cms__geo_maps__metadata__title}</h3>
                        <h:panelGroup id="metadataPanel" >
                        	<ul class="nav nav-tabs" role="tablist">
                        		<ui:repeat value="#{navigationHelper.supportedLanguages}" var="language" varStatus="status">
                                    <li role="presentation" class="#{language == geoMapBean.selectedLanguage ? 'active' : ''}">
                                    <a href="#nameLanguage-#{status.index}" aria-controls="nameLanguage-#{status.index}" role="tab" data-toggle="tab">#{language}</a>
                                    </li>
                                </ui:repeat>
                        	</ul>
                        	<div class="tab-content">
                        	<ui:repeat value="#{navigationHelper.supportedLanguages}" var="language" varStatus="status">
                                <div role="tabpanel" class="tab-pane #{status.index == 0 ? 'active' : ''}" id="nameLanguage-#{status.index}">
                        	
	                        	<div class="admin__content-inner-content__input_form">
									<!-- TITLE -->
			                        <div class="input_form__option_group">
			                            <div class="input_form__option_label">
			                                <label for="mapTitle_#{language}">#{msg.name}:</label>
			                            </div>
			                            <div class="input_form__option_marker #{language == navigationHelper.defaultLocale.language ? 'in' : ''}">
			                            <label>*</label>
			                            </div>
			                            <div class="input_form__option_control">
			                                <h:inputText id="mapTitle_#{language}" styleClass="form-control"
			                                    value="#{geoMapBean.currentMap.getTitle(language).value}" required="#{language == navigationHelper.defaultLocale.language}" requiredMessage="#{msg.error__title_required}"/>
			                            </div>
			                            <div class="input_form__option_help">
			                                <button type="button" class="btn btn--clean" data-toggle="helptext" for="titleHelp_#{language}">
			                                    <i class="fa fa-question-circle" aria-hidden="true"></i>
			                                </button>
			                            </div>
			                            <div id="titleHelp_#{language}" class="input_form__option_control_helptext">#{msg.cms__geo_maps__metadata_title__help}</div>
			                        </div>
			                        
			                        <!-- DESCRIPTION -->
			                        <div class="input_form__option_group">
			                            <div class="input_form__option_label">
			                                <label for="mapDesc_#{language}">#{msg.description}:</label>
			                            </div>
			                            <div class="input_form__option_marker">
			                            <label>*</label>
			                            </div>
			                            <div class="input_form__option_control">
			                                <h:inputTextarea id="mapDesc_#{language}" styleClass="form-control"
			                                    value="#{geoMapBean.currentMap.getDescription(language).value}"/>
			                            </div>
			                            <div class="input_form__option_help">
			                                <button type="button" class="btn btn--clean" data-toggle="helptext" for="descHelp_#{language}">
			                                    <i class="fa fa-question-circle" aria-hidden="true"></i>
			                                </button>
			                            </div>
			                            <div id="descHelp_#{language}" class="input_form__option_control_helptext">#{msg.cms__geo_maps__metadata_description__help}</div>
			                        </div>
								</div>
								</div>
								</ui:repeat>
                            </div>
                       </h:panelGroup>
                        <h3>#{msg.cms__geo_maps__map__title}</h3>
                        <h:panelGroup id="mapPanel" >
                        	<div class="admin__content-inner-content__input_form">
								<!-- TYPE -->
		                        <div class="input_form__option_group">
		                            <div class="input_form__option_label">
		                                <label for="mapType">#{msg.cms__geo_maps__type__label}:</label>
		                            </div>
		                            <div class="input_form__option_marker in">
		                            <label>*</label>
		                            </div>
		                            <div class="input_form__option_control">
		                            	<div class="custom-control custom-control--select">
						                    <h:selectOneMenu
						                        id="mapType"
						                        styleClass="form-control" 
						                        value="#{geoMapBean.currentMap.type}"
						                        required="true" requiredMessage="#{msg.error__type_required}">
						                        <f:selectItem itemValue="#{null}" itemLabel="#{msg.select}" itemDisabled="true" noSelectionOption="true"></f:selectItem>
						                        <f:selectItems 
						                            value="#{geoMapBean.possibleMapTypes}"
						                            var="type"
						                            itemValue="#{type}"
						                            itemLabel="#{msg[type]}" />
						                         <f:ajax render="mapPanel"/>
						                    </h:selectOneMenu>
						                </div>
		                            </div>
		                            <div class="input_form__option_help">
		                                <button type="button" class="btn btn--clean" data-toggle="helptext" for="typeHelp">
		                                    <i class="fa fa-question-circle" aria-hidden="true"></i>
		                                </button>
		                            </div>
		                            <div id="typeHelp" class="input_form__option_control_helptext">#{msg.cms__geo_maps__type__help}</div>
		                        </div>
		                        <ui:fragment rendered="#{geoMapBean.currentMap.type == 'MANUAL'}">
		                        	<div>#{msg.cms__geo_maps__map__help}</div>
		                        	<map class="input_form__geomap" id="geomap"></map>
		                        	<popover id="geoMapPopoverTemplate">
		                        		<h4 data-metadata="title"></h4>
		                        		<span data-metadata="description"></span>
		                        	</popover>
		                        	<div>#{msg.cms__geo_maps__map_token__help}</div>
		                        	<h:inputHidden id="featuresInput" value="#{geoMapBean.currentMap.featuresAsString}"></h:inputHidden>
		                        </ui:fragment>
			            	</div>
			            	<br/>
			            	<div class="admin__content-inner-content__empty_form" id="featureForm">
				            	<ui:fragment rendered="#{geoMapBean.currentMap.type == 'MANUAL'}">
					            	<metadataEditor/>
					            	<script>
				            			init();
		                        	</script>
				            	</ui:fragment>
			            	</div>
                        </h:panelGroup>
                        <br/>
                        <div class="admin__content-inner-content__controls">
                            <h:commandButton styleClass="btn btn--default" value="#{msg.reset}" action="#{geoMapBean.resetCurrentMap}">
                            	<f:ajax execute="@none" render="@all"/>
                            </h:commandButton>
                        	<h:commandButton styleClass="btn btn--success" value="#{msg.save}" action="#{geoMapBean.saveCurrentMap}"></h:commandButton>
                        </div>
                        
                    </h:form>
                </div>
            </div>
        </ui:fragment>
    </ui:define>

    <!-- SIDEBAR -->
    <ui:define name="sidebar">
        <adminWidget:widget_admin />
        <adminWidget:widget_crowdsourcing />
        <adminWidget:widget_cms />
    </ui:define>
</ui:composition>
