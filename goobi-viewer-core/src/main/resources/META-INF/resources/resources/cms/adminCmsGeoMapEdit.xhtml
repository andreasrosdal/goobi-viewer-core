<ui:composition 
    xmlns="http://www.w3.org/1999/xhtml" 
    xmlns:h="http://xmlns.jcp.org/jsf/html" 
    xmlns:f="http://xmlns.jcp.org/jsf/core" 
    xmlns:jsf="http://xmlns.jcp.org/jsf"
    xmlns:ui="http://xmlns.jcp.org/jsf/facelets" 
    xmlns:pt="http://xmlns.jcp.org/jsf/passthrough"
    xmlns:c="http://java.sun.com/jsp/jstl/core" 
    xmlns:viewerComponent="http://xmlns.jcp.org/jsf/composite/components"
    xmlns:adminWidget="http://xmlns.jcp.org/jsf/composite/admin/widgets" 
    template="/resources/themes/#{navigationHelper.theme}/templateAdmin.html">

    <ui:define name="metadata">
        <f:metadata>
            <f:event type="preRenderView" listener="#{navigationHelper.setCurrentPageAdmin( (geoMapBean.currentMapId == null) ? 'adminCmsGeoMapNew' : 'adminCmsGeoMapEdit')}" />
        </f:metadata>
    </ui:define>

    <!-- CONTENT -->
    <ui:define name="content">
	    
	   	<script>
	
	   		var mapEditor = new cmsJS.GeoMapEditor({
	   			mapId: "geomap",
	   		    displayLanguage : "#{navigationHelper.localeString}",
	   		    supportedLanguages: #{navigationHelper.supportedLanguagesAsJson},
	   		  	popover: "#geoMapPopoverTemplate",
	 	    	allowEditFeatures: false,
	 	    	loader: ".ajax_loader",
		  		msg: {
		          	emptyMarker: "#{msg.request__insert_metadata}",
		          	titleLabel: "#{msg.title}",
		              titleHelp: "#{msg.cms__geomaps__feature_title__help}",
		              descLabel: "#{msg.description}",
		              descHelp: "#{msg.cms__geomaps__feature_description__help}",
		              deleteLabel: "#{msg.delete}"
		          }
	   		})
	
	    </script>
    
    
        <ui:fragment id="cmsGeoMaps" rendered="#{userBean.user.isHasCmsPrivilege('CMS_GEOMAPS')}">
            <div id="cmsGeoMaps">
                <h1 class="admin__content-inner-title">#{geoMapBean.currentMapId == null ?  msg.cms__geomap_new__title : msg.cms__geomap_edit__title}
                </h1>
                
                <viewerComponent:adminBreadcrumbs />
                
                <div class="admin__content-inner-content">
	                <div class="admin__info-text">
	               		<h:outputText escape="false" value="#{msg.cms__geomap_edit__description}"></h:outputText>
	               </div>
                
                    <h:form id="geoMapEditForm" prependId="false">
                        <h2>#{msg.cms__geomaps__metadata__title}</h2>
                        <h:panelGroup id="metadataPanel" >
                        	<ul class="nav nav-tabs" role="tablist">
                        		<ui:repeat value="#{navigationHelper.supportedLanguages}" var="language" varStatus="status">
                                    <li role="presentation" class="#{language == geoMapBean.selectedLanguage ? 'active' : ''}">
<!--                                     <a href="#nameLanguage-#{status.index}" aria-controls="nameLanguage-#{status.index}" role="tab" data-toggle="tab">#{language}</a> -->
                                    	<h:commandLink action="#{geoMapBean.setSelectedLanguage(language)}" value="#{language}" styleClass="-bluelink">
                                    		<f:passThroughAttribute name="role" value="tab"/>
                                    		<f:ajax render="metadataPanel"></f:ajax>
                                    	</h:commandLink>
                                    </li>
                                </ui:repeat>
                        	</ul>
                        	<div class="tab-content">
                        	<ui:param name="language" value="de"></ui:param>
<!--                         	<ui:repeat value="#{navigationHelper.supportedLanguages}" var="language" varStatus="status"> -->
                                <div role="tabpanel" class="tab-pane active" id="nameLanguage-#{geoMapBean.selectedLanguage}">
                        	
	                        	<div class="admin__content-inner-content__input_form">
									<!-- TITLE -->
			                        <div class="input_form__option_group">
			                            <div class="input_form__option_label">
			                                <label for="mapTitle">#{msg.name}:</label>
			                            </div>
			                            <div class="input_form__option_marker #{geoMapBean.selectedLanguage == navigationHelper.defaultLocale.language ? 'in' : ''}">
			                            <div>*</div>
			                            </div>
			                            <div class="input_form__option_control">
			                                <h:inputText id="mapTitle" styleClass="form-control"
			                                    value="#{geoMapBean.currentMap.getTitle(geoMapBean.selectedLanguage).value}" required="#{geoMapBean.selectedLanguage == navigationHelper.defaultLocale.language}" requiredMessage="#{msg.error__title_required}"/>
			                            </div>
			                            <div class="input_form__option_help">
			                                <button type="button" class="btn btn--clean" data-toggle="helptext" for="titleHelp" aria-label="inline help icon">
			                                    <i class="fa fa-question-circle" aria-hidden="true"></i>
			                                </button>
			                            </div>
			                            <div id="titleHelp" class="input_form__option_control_helptext">#{msg.cms__geomaps__metadata_title__help}</div>
			                        </div>
			                        
			                        <!-- DESCRIPTION -->
			                        <div class="input_form__option_group">
			                            <div class="input_form__option_label">
			                                <label for="mapDes">#{msg.description}:</label>
			                            </div>
			                            <div class="input_form__option_marker">
			                            <div>*</div>
			                            </div>
			                            <div class="input_form__option_control">
			                                <h:inputTextarea id="mapDesc" styleClass="form-control" value="#{geoMapBean.currentMap.getDescription(geoMapBean.selectedLanguage).value}">
								 				<f:passThroughAttribute name="aria-label" value="#{msg.description}" />
								 			</h:inputTextarea>
			                            </div>
			                            <div class="input_form__option_help">
			                                <button type="button" class="btn btn--clean" data-toggle="helptext" for="descHelp" aria-label="inline help icon">
			                                    <i class="fa fa-question-circle" aria-hidden="true"></i>
			                                </button>
			                            </div>
			                            <div id="descHelp" class="input_form__option_control_helptext">#{msg.cms__geomaps__metadata_description__help}</div>
			                        </div>
								</div>
								</div>
<!-- 								</ui:repeat> -->
                            </div>
                       </h:panelGroup>
                        <div class="admin__content-inner-content__form_title">
	                        <h2>#{msg.cms__geomaps__map__title}</h2>
	                        <span class="ajax_loader">
								<img src="#{request.contextPath}/resources/images/infinity_loader.gif" class="img-responsive" alt="Waiting..." />
							</span>
						</div>
						
						<h:panelGroup id="featureSetsPanel">
						
							<ui:repeat var="featureSet" value="#{geoMapBean.currentMap.featureSets}" varStatus="status">
								<div class="cms__geomap__featureset_input" style="padding: 5px; border:1px solid black">
									<div>
										<h4>Featureset #{status.index+1}</h4>
										<button jsf:action="#{geoMapBean.removeFeatureSet(geoMapBean.currentMap, featureSet)}">
											<i class="fa fa-trash"></i>
											<f:ajax execute="featureSetsPanel" render="mapPanel featureSetsPanel"></f:ajax>
										</button>
									</div>
									<div>
										<!-- MARKER -->
				                        <div class="input_form__option_group">
				                            <div class="input_form__option_label">
				                                <label for="mapMarker">#{msg.cms__geomaps__marker__label}:</label>
				                            </div>
				                            <div class="input_form__option_marker">
				                            <div>*</div>
				                            </div>
				                            <div class="input_form__option_control">
				                            	<div class="custom-control custom-control--select">
								                    <h:selectOneMenu
								                        id="mapMarker"
								                        styleClass="form-control" 
								                        value="#{featureSet.marker}"
								                        required="false" requiredMessage="#{msg.error__type_required}">
								                        <f:selectItems 
								                            value="#{geoMapBean.possibleMarkers}"
								                            var="marker"
								                            itemValue="#{marker.name}"
								                            itemLabel="#{msg[marker.name]}" />
								                         <f:ajax execute="mapPanel" render="mapPanel"/>
								                    </h:selectOneMenu>
								                </div>
				                            </div>
				                            <div class="input_form__option_help">
				                                <button type="button" class="btn btn--clean" data-toggle="helptext" for="markerHelp" aria-label="inline help icon">
				                                    <i class="fa fa-question-circle" aria-hidden="true"></i>
				                                </button>
				                            </div>
				                            <div id="markerHelp" class="input_form__option_control_helptext">#{msg.cms__geomaps__marker__help}</div>
				                        </div>
									</div>
									<!-- SOLR QUERY -->
			                        <ui:fragment rendered="#{featureSet.queryResultSet}">
				                        <div class="input_form__option_group">
				                            <div class="input_form__option_label">
				                                <label for="solrQueryInput">#{msg.cms__geomaps__solrquery__label}:</label>
				                            </div>
				                            <div class="input_form__option_marker in">
				                            <div>*</div>
				                            </div>
				                            <div class="input_form__option_control">
							                    <div class="input_form__option-message">
								                    <h:messages for="solrQueryInput" 
								                        infoClass="cms-module__option-message-status success" 
								                        warnClass="cms-module__option-message-status warning"
								                        errorClass="cms-module__option-message-status danger" />
								
								                    <div class="input_form__option-message-mark">
								                        <i class="fa fa-check" aria-hidden="true"></i>
								                        <i class="fa fa-exclamation" aria-hidden="true"></i>
								                    </div>
								                </div>
							                    <h:inputText id="solrQueryInput" styleClass="form-control"  
							                    	value="#{featureSet.solrQuery}" 
							                    	required="true" requiredMessage="#{msg.error__query_required}"
							                    	>
							                    	<f:validator validatorId="solrQueryValidator" for="solrQueryInput" />
							                    	<f:ajax event="blur" render="mapPanel"/>
							                    </h:inputText>							                    
				                            </div>
				                            <div class="input_form__option_help">
				                                <button type="button" class="btn btn--clean" data-toggle="helptext" for="queryHelp" aria-label="inline help icon">
				                                    <i class="fa fa-question-circle" aria-hidden="true"></i>
				                                </button>
				                            </div>
				                            <div id="queryHelp" class="input_form__option_control_helptext">#{msg.cms__geomaps__solrquery__help}</div>
				                        </div>
				                        <!-- PUPUP CONTENT -->
				                        <div class="input_form__option_group">
				                            <div class="input_form__option_label">
				                                <label for="popupContent">#{msg.cms__geomaps__popup_content__label}:</label>
				                            </div>
				                            <div class="input_form__option_marker">
				                            <div>*</div>
				                            </div>
				                            <div class="input_form__option_control">
				                            	<div class="custom-control custom-control--select">
								                    <h:selectOneMenu
								                        id="popupContent"
								                        styleClass="form-control" 
								                        value="#{featureSet.markerTitleField}"
								                        required="false">
								                        <f:selectItem itemValue="#{null}" itemLabel="#{msg.cms__geomaps__popup_content__option__none}"></f:selectItem>
								                        <f:selectItem itemValue="NORM_NAME" itemLabel="#{msg.cms__geomaps__popup_content__option__place}"></f:selectItem>
								                        <f:selectItem itemValue="MD_VALUE" itemLabel="#{msg.cms__geomaps__popup_content__option__metadata}"></f:selectItem>
								                        <f:ajax execute="mapPanel" render="mapPanel"/>
								                    </h:selectOneMenu>
								                </div>
				                            </div>
				                            <div class="input_form__option_help">
				                                <button type="button" class="btn btn--clean" data-toggle="helptext" for="popupContentHelp" aria-label="inline help icon">
				                                    <i class="fa fa-question-circle" aria-hidden="true"></i>
				                                </button>
				                            </div>
				                            <div id="popupContentHelp" class="input_form__option_control_helptext">#{msg.cms__geomaps__popup_content__help}</div>
				                        </div>
				                    </ui:fragment>
				                </div>
							</ui:repeat>
						
							<div>
								<ui:param name="featureSetType" value="#{MANUAL}"/>
								<h:selectOneMenu value="#{featureSetType}">
									<f:selectItem itemValue = "MANUAL" itemLabel = "MANUAL" /> 
	   								<f:selectItem itemValue = "SOLR_QUERY" itemLabel = "SOLR_QUERY" /> 
								</h:selectOneMenu>
								<button jsf:action="#{geoMapBean.addFeatureSet(geoMapBean.currentMap, featureSetType)}">
								<i class="fa fa-plus"></i>
								<f:ajax execute="featureSetsPanel mapPanel" render="mapPanel featureSetsPanel"></f:ajax>
								</button>
							</div>
														
						
						</h:panelGroup>
						
                        <h:panelGroup id="mapPanel" >
	                        
                        	<div class="admin__content-inner-content__input_form">
								
		                        	<div>#{msg.cms__geomaps__map__help}</div>
		                        	<map class="input_form__geomap" id="geomap"></map>
		                        	<popover id="geoMapPopoverTemplate">
		                        		<h3 data-metadata="title"></h3>
		                        		<span data-metadata="description"></span>
		                        	</popover>
		                        		<div>#{msg.cms__geomaps__map_token__help}</div>
		                        	<h:inputHidden id="featuresInput" value="#{geoMapBean.activeFeatureSetAsString}"></h:inputHidden>
		                        	<h:inputHidden id="viewInput" value="#{geoMapBean.currentMap.initialView}"></h:inputHidden>
			            	</div>
			            	<br/>
			            	<div class="admin__content-inner-content__empty_form" id="featureForm">
					            	<metadataEditor/>
				            	<script>
				            	$(document).ready(() => {
				            	    if($("#geomap").length > 0) {				            	        
					            	    mapEditor.geoMap.config.popover = "#geoMapPopoverTemplate";
					            	    
					            	    mapEditor.init(window.storedView);
					            	    mapEditor.setAllowEditFeatures(true);

					            	    <c:forEach var="featureSet" items="#{geoMapBean.currentMap.featureSets}">
					            	    {
					            	    	let config = {
					            	    			clusterMarkers : #{featureSet.queryResultSet},
					            	    			popoverOnHover : #{featureSet.queryResultSet},
					            	    			markerIcon : #{featureSet.markerAsJSON},
					            	    			<c:if test="#{featureSet.queryResultSet}">
					            	    			heatmap: {
					            	                	enabled: #{configurationBean.useHeatmapForCMSMaps()},
					            	                	heatmapUrl:  "#{geoMapBean.heatmapUrl}",
								    		          	featureUrl:  "#{geoMapBean.featureUrl}",
					            	                	filterQuery: "BOOL_WKT_COORDS:*",
					            	    		        labelField: "LABEL",
					            	    		        filterQuery: "#{featureSet.solrQueryEncoded}",
								    		      	    labelField:  "#{featureSet.markerTitleField}",
					            	                },
							    		      	    </c:if>

					            	    	}
					            	    	if(#{featureSet.queryResultSet and configurationBean.useHeatmapForCMSMaps()}) {	
					            	    		mapEditor.geoMap.addFeatureGroup(config, []);
					            	    	} else {
					            	    		let featureGroup = mapEditor.geoMap.addFeatureGroup(config, #{featureSet.featuresAsString});
					            	    		if(#{featureSet == geoMapBean.activeFeatureSet}) {
					            	    				mapEditor.activeFeatureGroup = featureGroup;
					            	    				console.log("set aciveFeatureGroup ", featureGroup);
					            	    		}
					            	    	}
					            	    }
					            	    
					            	    </c:forEach>
					            	    
					            	    viewerJS.jsfAjax.begin.subscribe((e) => {
					            	        if(e.source.id === "mapMarker" || e.source.id === "popupContent") {					            	            
					            	            window.storedView = mapEditor.geoMap.getView();
					            	        } else {
					            	            window.storedView = undefined;
					            	        }
					            	    })
				            	    }
				            	})
	                        	</script>
			            	</div>
                        </h:panelGroup>
                        <br/>
                        <div class="admin__content-inner-content__controls">
                            <h:commandLink styleClass="btn btn--default" value="#{msg.reset}" action="#{geoMapBean.resetCurrentMap}">
                            	<f:ajax execute="@none" render="@all"/>
                            </h:commandLink>
                        	<h:commandButton styleClass="btn btn--success" value="#{msg.save}" action="#{geoMapBean.saveCurrentMap}">
                        		<f:ajax render="@form :messages" execute="@form"></f:ajax>
                        	</h:commandButton>
                        </div>
                        
                    </h:form>
                </div>
            </div>
        </ui:fragment>
    </ui:define>

</ui:composition>
