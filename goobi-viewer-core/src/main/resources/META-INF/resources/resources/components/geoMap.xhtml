<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
	xmlns:composite="http://xmlns.jcp.org/jsf/composite"
	xmlns:f="http://xmlns.jcp.org/jsf/core"
	xmlns:h="http://xmlns.jcp.org/jsf/html">

    <composite:interface>
        <composite:attribute name="geoMap" required="true" type="io.goobi.viewer.model.maps.GeoMap" />
    	<composite:attribute name="mapId" required="false" default="geomap" /><composite:attribute name="linkTarget" required="false" default="_self" />
    	<composite:attribute name="linkToSearch" required="false" default="true" />
    	<composite:attribute name="linkTarget" required="false" default="_self" />
    	<composite:attribute name="showAnnotations" type="java.lang.Boolean" required="false" default="false"/>
    	<composite:attribute name="popoverOnHover" type="java.lang.Boolean" required="false" default="#{cc.attrs.geoMap.type == 'SOLR_QUERY'}"/>
    	<composite:attribute name="clusterMarkers" type="java.lang.Boolean" required="false" default="#{cc.attrs.geoMap.type == 'SOLR_QUERY'}"/>
    	<composite:attribute name="popoverClass" required="false" default="geomap_popover"/>
    	<composite:attribute name="highlightDocumentId" required="false" default=""/>
    </composite:interface>
    
	<composite:implementation>

		<div id="#{cc.attrs.mapId}" class="geomap" />
		<popover id="popoverTemplate_#{cc.attrs.mapId}" class="#{cc.attrs.popoverClass}">
				<h3 data-metadata="title"></h3>
				<span data-metadata="description"></span> 
		</popover>
		<script>
		/**
		* put this code in anonymous function and execute it to limit the scope of declared variables to 
		* this script only
		**/
		//<![CDATA[
		(() => {
        	var geoMap = new viewerJS.GeoMap({
        	    mapId: "#{cc.attrs.mapId}",
           		language: "#{navigationHelper.localeString}",
           		iconPath: "#{request.contextPath}/resources/images/map",
           		layer : {
	           		allowMovingFeatures: false,
	           		popover: #{cc.attrs.geoMap.showPopover} ? "#popoverTemplate_#{cc.attrs.mapId}" : undefined,
	           		popoverOnHover: #{cc.attrs.popoverOnHover},
	           		clusterMarkers: #{cc.attrs.clusterMarkers}
           		}
           	});
        	var initMap = function(view, features) {
        	    geoMap.init(view);
            	let layer = new viewerJS.GeoMap.featureGroup(geoMap, {
            	    markerIcon: #{cc.attrs.geoMap.markerAsJSON}
            	})
            	layer.onFeatureClick.subscribe(feature => {
           	       if(feature.properties && feature.properties.link && !feature.properties.highlighted) {
           	           window.location.assign(feature.properties.link);
           	       }
           	    });
	        	if(#{cc.attrs.linkToSearch and cc.attrs.geoMap.type == 'SOLR_QUERY'}) {
	                let searchUrlTemplate = '#{geoMapBean.getCoordinateSearchQueryTemplate(cc.attrs.geoMap)}';
	                layer.onFeatureClick.subscribe( (feature) => {
	                    let queryUrl = searchUrlTemplate.replace("{lng}", feature.geometry.coordinates[0]);
	                    queryUrl = queryUrl.replace("{lat}", feature.geometry.coordinates[1]);
	                    window.open(queryUrl, "#{cc.attrs.linkTarget}");
	                });
	            }
	        	
	        	let highlightDocumentId = "#{cc.attrs.highlightDocumentId}";
	        	if(highlightDocumentId) {
	        	    features.filter(f => f.properties.documentId == highlightDocumentId).forEach(f => f.properties.highlighted = true);
	        	}
	        	
	        	
	        	let queryAdapter = L.SolrHeatmapBaseQueryAdapter.extend({
	        	    ajaxOptions: function(bounds) {
	        	        let options = {
	        	          url: this._solrQuery(bounds)
	        	        };
	        	        return options;
	        	      },
	        	      responseFormatter: function(data) {
	        	        return {
	        	            "WKT_COORDS" : data
	        	        }
	        	      },
	        	      _solrQuery: function(bounds) {
	        	        let region = this.layer._mapViewToWkt(bounds);
	        	        return this.layer._solrUrl + this.options.field + '?' + 
	        	                "region=" + encodeURIComponent(region);
	        	      }
	        	    })
	        	L.SolrHeatmapQueryAdapters.goobiViewerAdapter = queryAdapter;
	        	
	        	let heatmapUrl = "http://localhost:8082/viewer/api/v1/index/heatmap/";

	        	let heatmap = L.solrHeatmap(heatmapUrl, {
	        	    field: "WKT_COORDS",
	        	    type: "clusters",
	        	    gridLevel: 2,
	        	    queryAdapter: "goobiViewerAdapter"    
	        	});
	        	heatmap.addTo(geoMap.map);
	        	

	        	
	        	
	        	
//             	layer.init(features, true);
        	}
        	
           	$(document).ready(() => {   
            	let view = #{cc.attrs.geoMap.initialView};
            	let features = #{cc.attrs.geoMap.featuresAsString};
            	if(features.length > 0 ) {
            	    initMap(view, features);
            	} else {
            	    $("##{cc.attrs.mapId}").parent().hide();
            	}
            })
		    
		})();
		//]]>
		</script>
	</composite:implementation>
</ui:composition>