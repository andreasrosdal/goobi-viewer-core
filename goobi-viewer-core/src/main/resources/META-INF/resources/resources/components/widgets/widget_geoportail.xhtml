<ui:composition xmlns="http://www.w3.org/1999/xhtml" 
    xmlns:f="http://xmlns.jcp.org/jsf/core" 
    xmlns:h="http://xmlns.jcp.org/jsf/html"
    xmlns:ui="http://xmlns.jcp.org/jsf/facelets" 
    xmlns:composite="http://xmlns.jcp.org/jsf/composite">

    <!-- interface options -->
    <composite:interface>
    	<composite:attribute name="collapse" type="java.lang.Boolean" required="false" default="false"/>
    </composite:interface>

    <!-- component content -->
    <composite:implementation>
    
    		<script src="//apiv3.geoportail.lu/apiv3loader.js"  type="text/javascript"></script>
	        <!-- WIDGET WORK COUNT STANDARD -->
	        <h:panelGroup rendered="#{cc.attrs.collapse == false}">
		        <div id="widgetGeoportail" class="widget widget-geoportail">
		        	<h2>#{msg.location}</h2>
		        	<div class="widget__body">
<!-- 		        		<iframe id="iframe_geoportail" style="width:100%;height:400px;"/> -->
						<button type="button" onclick="switchLayer()">Switch layer</button>
		        		<div id="map_geoportail" style="width:100%;height:400px;"/>
		        		<script>
		        			let urlString = "#{activeDocumentBean.getSingleMetadataValue('MD_GML_POINT_UNTOKENIZED', activeDocumentBean.getTopDocument())}"
// 		        			console.log("parse ", urlString, "for luxembourg geoportail map");
// 			        		document.getElementById("iframe_geoportail").src = urlString;
		        			
			        		let url = new URL(urlString);
		        			let zoom = url.searchParams.get('zoom');
		        			let x = url.searchParams.get('X');
		        			let y = url.searchParams.get('Y');
		        			let layers = url.searchParams.get('layers');
		        			let opacities = url.searchParams.get('opacities');
		        			let bgLayer = url.searchParams.get('bgLayer');
		        			let crosshair = url.searchParams.get('crosshair');
		        			
		        			let backgroundLayers = ["blank", "basemap_2015_global", "streets_jpeg", "topo_bw_jpeg", "topogr_global"];
		        			
		        			let geoportail_map = new lux.Map({
		        			    target: 'map_geoportail',
		        			    bgLayer: "topogr_global",
		        			    layers: ["streets_jpeg"],
		        			    zoom: parseInt(zoom),
		        			    position: [parseFloat(x), parseFloat(y)],
		        			    positionSrs: '3857'
		        			  });
		        			geoportail_map.showMarker(
		        			        {positioning: 'bottom-center',
		        			         iconURL: '#{request.contextPath}/resources/images/map/marker-icon.png',
		        			      });
		        			geoportail_map.getMapReadyPromise().then(() => {
								let mapLayers = geoportail_map.getLayers().getArray();
								mapLayers[1].setVisible(false);
		        			});
		        			
							function switchLayer() {
							    let mapLayers = geoportail_map.getLayers().getArray();
							    if(mapLayers[1].getVisible()) {
							        mapLayers[1].setVisible(false);
							    } else {
							        mapLayers[1].setVisible(true);
							    }
							}

		        		</script>
		        	</div>

		        </div>
	        </h:panelGroup>
	        
	        <!-- WIDGET WORK COUNT FOLDOUT -->
	        <h:panelGroup rendered="#{cc.attrs.collapse == true}">
	        	<div id="widgetGeoportail" class="widget widget-geoportail">
					<h2 >
						<a href="#geoportailCollapse" data-toggle="collapse" aria-expanded="false" aria-controls="geoportailCollapse">
							#{msg.location}
							<i class="fa fa-arrow-down" aria-hidden="true"></i>
						</a>
					</h2>
					
					<div id="geoportailCollapse" class="collapse">
						
					</div>
		        </div>
	        </h:panelGroup>
    </composite:implementation>
</ui:composition>