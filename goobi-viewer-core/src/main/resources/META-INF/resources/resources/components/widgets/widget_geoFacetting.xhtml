<ui:composition 
    xmlns="http://www.w3.org/1999/xhtml" 
    xmlns:f="http://xmlns.jcp.org/jsf/core" 
    xmlns:h="http://xmlns.jcp.org/jsf/html"
    xmlns:ui="http://xmlns.jcp.org/jsf/facelets" 
    xmlns:composite="http://xmlns.jcp.org/jsf/composite">

    <!-- INTERFACE OPTIONS -->
    <composite:interface />

    <!-- COMPONENT CONTENT -->
    <composite:implementation>
        
        <!--  WIDGET Geo facetting -->
        <ui:fragment rendered="#{searchBean.facets.geoFacetting.active and (cc.attrs.widget.type == 'widgetSearchDrillDown' or cc.attrs.widget.type == null)}">
        <h:form>
	        <div class="widget widget-geofacetting">
				<div class="widget-geofacetting__topbar">
					<div class="widget-geofacetting__item geofacetting-label">
						<h3>#{msg.widget_geofacetting__label}
						<button type="button" id="expandFacetMap" data-toggle="tooltip" title="#{msg.fullscreen_enter}" class="widget-geofacetting__expand" aria-label="#{msg.fullscreen_enter}">
		                        	<i class="fa fa-expand"/>
		                </button>
						</h3>
					</div>
	
				</div>
				<div class="widget__body">
					<div id="geoFacettingMap" class="geo-map"></div>
				</div>
				
				<div id="geoFacettingOverlayMap" class="overlay__geomap" >
					<h:commandButton id="submitSearch" styleClass="btn btn--full" action="pretty:newSearch5" value="#{msg.search}">
		                    <f:setPropertyActionListener target="#{searchBean.activeSearchType}" value="0" />
		        	</h:commandButton>
				</div>
				
				<div id="widgetGeoFacettingOverlay" class="widget-geofacetting__overlay">
					<div id="geoFacettingOverlayMap" class="widget-geofacetting__overlay__geo-map"></div>
				</div>
	
			</div>
			<h:commandScript name="setGeoFacetFeature" render="@form" action="#{searchBean.facets.geoFacetting.setFeatureFromContext()}"
			 onevent="applyDrilldown">
			</h:commandScript>
	          <script type="text/javascript">	  
	          //<![CDATA[
	              
	              function applyDrilldown(data) {
	                  console.log("apply drilldown, ", data.status);
	                  if(data && data.status=="success") {	                      
	                  	let $searchButton = $("#submitSearch");
                 	 	if($searchButton.length > 0) {
                 	 	    $searchButton.click();
                 	 	}
	                  }
	              }
	              
		            function initFacetWidgetMap() {
		                let areaString = '#{searchBean.facets.geoFacetting.feature}';
		                this.area = areaString.length > 0 ? JSON.parse(areaString) : undefined;
		                console.log("area is ", areaString, this.area, setGeoFacetFeature);
		                let geoMap = new viewerJS.GeoMap({
	                	    mapId: "geoFacettingMap",
	                   		allowMovingFeatures: false,
	                   		language: "#{navigationHelper.localeString}",
	                   		popoverOnHover: false,
	                   		clusterMarkers: false,
	                   		fixed: true
	                   	});
	
	                    	geoMap.init({
	                            zoom: 1,
	                            center: [0,0] //long, lat
	                        });
	                    	if(this.area) {	                    	    
		                    	console.log("draw area" , this.area);
		                        switch(this.area.type) {
		                            case "polygon":
		                                geoMap.drawPolygon(this.area.vertices, {color: "blue"}, true);
		                                break;
		                            case "circle":
		                                geoMap.drawCircle(this.area.center, this.area.radius, {color: "blue"}, true);
		                                break;
		                            case "rectangle":
		                                geoMap.drawRectangle([this.area.vertices[0], this.area.vertices[2]], {color: "blue"}, true);
		                                break;
		                        }
	                    	}
	
						$("#expandFacetMap").on("click", e => {
						    console.log("open overlay ", this);
	                       	viewerJS.overlay.open($('#geoFacettingOverlayMap'), true, false, $node => {
	                       	    $node.remove();
	                       	    console.log("submit area ", this.area);
	                       	    //$("[data-drilldown='geoCoords']").val(JSON.stringify(this.area));
	                       	 	setGeoFacetFeature({feature : this.area ? JSON.stringify(this.area) : ""});
	                       	 	
	                       	})
	                       	.then($node => {
	                       	    console.log("mount overlay map", $node.get(0));
		                       	 riot.mount($node.get(0), "geomapsearch", {
		     					    inactive: false,
		     					    area : this.area,
		     					    onFeatureSelect: area => {
		     					        console.log("Set facetting area", area);
		     					        this.area = area;
		     					    }
		     					}); 
	                       	});                       	
		                })
					}
					$(document).ready(e => {					    
					    let facetWidgetMap = new initFacetWidgetMap();
					})				    
	            //]]>
		        </script>
        </h:form>
        
        </ui:fragment>
    </composite:implementation>
</ui:composition>
