<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
	xmlns:c="http://java.sun.com/jsp/jstl/core"
	xmlns:h="http://xmlns.jcp.org/jsf/html"
	xmlns:f="http://xmlns.jcp.org/jsf/core"
	xmlns:jsf="http://xmlns.jcp.org/jsf"
	xmlns:pt="http://xmlns.jcp.org/jsf/passthrough"
	xmlns:viewer="http://xmlns.jcp.org/jsf/composite/components/partner"
	xmlns:viewerComponent="http://xmlns.jcp.org/jsf/composite/components"
	xmlns:widgetComponent="http://xmlns.jcp.org/jsf/composite/components/widgets">

	<!-- USER COMMENTS -->
	<ui:fragment
		rendered="#{activeDocumentBean.viewManager.allowUserComments}">
		<!-- JUMP TO THIS ANCHOR AFTER LOGIN -->
		<a name="userComments"></a>

		<div id="userComments" class="user-comments">
			<!-- USER NOT LOGGED IN -->
			<ui:fragment rendered="#{!userBean.loggedIn}">
				<div class="user-comments__message-login">
					<h3>#{msg.commentAdd}</h3>

					<h:outputText value="#{msg.commentDescription} " escape="false" />

					<br />

					<!-- TOGGLE LOGIN -->
					<button type="button" class="btn btn--link" data-toggle="modal"
						data-target="#userLoginModal" aria-label="#{msg.userNotLoggedIn}">
						<span>#{msg.login}</span>
					</button>
				</div>
			</ui:fragment>

			<h:form id="userCommentsForm" prependId="false">
				<ui:fragment rendered="#{userBean.loggedIn}">
					<h3>#{msg.userComments}</h3>
				</ui:fragment>

				<!-- EXISTING COMMENTS -->
				<ui:repeat var="comment"  varStatus="status"
					value="#{commentBean.commentsForCurrentPage}">
					<div class="user-comments__comment">
						<!-- USER IMAGE -->
						<div class="user-comments__comment-image">
							<img src="#{comment.owner.avatarUrl}" alt="User avatar" />
						</div>

						<!-- COMMENT METADATA -->
						<div class="user-comments__comment-metadata">
							<span class="user-comments__comment-metadata-creator">#{comment.owner.displayName}</span>
							<span class="user-comments__comment-metadata-date">#{navigationHelper.getLocalDate(comment.dateCreated)}</span>
						</div>

						<!-- COMMENT CONTENT -->
						<div class="user-comments__comment-content">
							<!-- CONTENT LOADER -->
							<div class="user-comments__comment-content-loader"></div>

							<!-- COMMENT OPTIONS -->
							<ui:fragment
								rendered="#{userBean.loggedIn or comment.dateModified != null}">
								<div class="user-comments__comment-content-options">
								
									<!-- LAST CHANGE -->
									<h:panelGroup rendered="#{comment.dateModified != null}"
										styleClass="user-comments__comment-content-options-last-change">
                                        #{msg.lastEdited} #{navigationHelper.getLocalDate(comment.dateModified)}
                                    </h:panelGroup>
								</div>
							</ui:fragment>

								<!-- COMMENT TEXT -->
								<div class="user-comments__comment-content-options-text in">
									#{comment.displayText}</div>

									<!-- EDIT COMMENT -->
									<ui:fragment
										rendered="#{userBean.user == comment.owner or userBean.user.superuser}">

										<div class="user-comments__action-wrapper">
											<!-- TRIGGER EDIT COMMENT MODAL -->
											<button jsf:action="#{activeDocumentBean.viewManager.currentPage.setCurrentComment(comment)}" class="btn--clean user-comments__edit-comment-button" data-backdrop="false" data-toggle="modal" data-target="#modalUserCommentEdit">
											  #{msg.edit}
											  <f:ajax render="modalUserCommentEdit:editForm"/> 
											</button>
											
											<!-- DELETE COMMENT -->
											<ui:fragment
												rendered="#{userBean.loggedIn and (userBean.user == comment.owner or userBean.user.superuser)}">
												
												<div class="user-comments__delete-comment-wrapper">
													<!-- INVISIBLE BUTTON FUNCTIONALITY-->
													<h:commandButton styleClass="user-comments__delete-comment-button -hidden"
														action="#{activeDocumentBean.viewManager.currentPage.deleteCommentAction(comment)}"
														title="#{msg.userCommentDelete}"
														data-trigger="delete-comment-final"
														value="#{msg.delete}">
														<f:passThroughAttribute name="data-trigger" value="delete-comment-final" />
														<f:ajax render="@form" />
													</h:commandButton>

													<!-- VISIBLE BUTTON -->
													<h:commandButton styleClass="user-comments__delete-comment-button" value="#{msg.delete}">
														<f:ajax execute="@form" render="@none" />
														<f:passThroughAttribute name="data-trigger" value="delete-comment" />
													</h:commandButton>
												</div>
											</ui:fragment>
										</div>
									</ui:fragment>
								</div>	
						</div>
						
					<div id="modalUserCommentEdit-#{comment.id}" styleClass="user-comments-modal" title="#{msg.userCommentEdit}">
						<yield to="body">
							<div class="col-3">#{msg.userCommentText}:</div>
							<div class="col-9 user-comments__comment-content-options-text-edit">
								<textarea id="modalUserCommentEdit-#{comment.id}-text">#{comment.text}</textarea>
							</div>
						</yield>
						<yield to="footer">
							<button id="modalUserCommentEdit-#{comment.id}-cancel" class="btn" data-dismiss="modal">#{msg.cancel}</button>
							<button id="modalUserCommentEdit-#{comment.id}-ok" class="btn btn--success accept ml-3" data-dismiss="modal">#{msg.save}</button>
						</yield>
					</div>
					<div class="d-none">
						<h:inputText data-value="comment-#{comment.id}" value="#{comment.text}">
							<f:ajax event="change"></f:ajax>
						</h:inputText>
					</div>
					
					<script>
						let props = {
							onClose: () => {
							    console.log("closing user comment edit modal");
							}
						}
						$("#modalUserCommentEdit-#{comment.id}-ok").on("click", () => {
						    let text = $("#modalUserCommentEdit-#{comment.id}-text").text();
						    console.log("save comment ", text);
						    let $input = $('[data-value="comment-#{comment.id}"]');
						    $input.val(text);
						    $input.change();
						})
						riot.mount("#modalUserCommentEdit-#{comment.id}", props, "modal")
					
					</script>
						
				</ui:repeat>
				
				<!-- DELETE COMMENT JS FUNCTIONALITY/SWEET ALERT CONFIRM + NOTIFICATION -->
	            <script>
					$('[data-trigger="delete-comment"]').on('click', function() {
						viewerJS.notifications.confirm('', '' ,'', '#{msg.userCommentDeleteText}')
							.then((result) => {
								  $(this).prev('.user-comments__delete-comment-button').click();
								  viewerJS.notifications.success("#{msg.commentDeleteSuccess}", "");
						});
					});
	        	</script>


				<!-- ADD COMMENT -->
				<ui:fragment rendered="#{userBean.loggedIn}">
					<div class="user-comments__add-comment">
						<label for="userCommentAdd"> <span>#{msg.userCommentAdd}</span>
						</label>
						<div class="user-comments__add-comment-add">
							<h:inputTextarea id="userCommentAdd"
								value="#{commentText}" />
						</div>
						<h:selectBooleanCheckbox id="commentLicenseCheckbox" value="#{commentRestricted}">Restricted</h:selectBooleanCheckbox>
						<div class="user-comments__add-comment-submit">
							<h:commandButton
								action="#{activeDocumentBean.viewManager.currentPage.createNewCommentAction(userBean.user)}"
								styleClass="btn btn--success" value="#{msg.addNoteText}">
								<f:ajax execute="userCommentAdd commentLicenseCheckbox" render="@form messages" />
							</h:commandButton>
						</div>
					</div>
				</ui:fragment>
			</h:form>
		</div>
		
		<script type="text/javascript">
            $( document ).ready( function() {
                viewerJS.userComments.init();

                jsf.ajax.addOnEvent( function( data ) {
                    var ajaxstatus = data.status;
            
                    switch ( ajaxstatus ) {
                    case "success":
                        viewerJS.userComments.init();
                        break;
                    }
                } );
            } );
        </script>
	</ui:fragment>
</ui:composition>