<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
	xmlns:c="http://java.sun.com/jsp/jstl/core"
	xmlns:h="http://xmlns.jcp.org/jsf/html"
	xmlns:f="http://xmlns.jcp.org/jsf/core"
	xmlns:jsf="http://xmlns.jcp.org/jsf"
	xmlns:pt="http://xmlns.jcp.org/jsf/passthrough"
	xmlns:viewer="http://xmlns.jcp.org/jsf/composite/components/partner"
	xmlns:viewerComponent="http://xmlns.jcp.org/jsf/composite/components"
	xmlns:widgetComponent="http://xmlns.jcp.org/jsf/composite/components/widgets">

	<!-- NOT (YET) ACCEPTED DOWNLOAD REQUESTS -->
    <ui:fragment rendered="#{not empty adminLicenseBean.downloadTicketRequests}">

            <!-- PENDING TICKETS HEADING -->
              <h2>
                  #{msg.admin__download_tickets__pending_requests}
              </h2>

            
            
            <div class="admin__download-tickets-pending-tickets-wrapper">
            
            
	            <ui:repeat var="ticket" value="#{adminLicenseBean.lazyModelDownloadTickets.paginatorList}" varStatus="status">
            
                                <div class="admin__boxed-entry admin__download-tickets-pending-ticket-single">
                                    
                                   	<!-- TITLE -->
                                       <div class="cms-widgets-overview__single-widget-title-wrapper">                                    	
                                        <h2 class="cms-widgets-overview__single-widget-title">#{msg.admin__dashboard_download_ticket_single_request} #{status.index + 1}</h2>
           							</div>

            						<div class="admin__download-tickets-pending-ticket-key-value-wrapper">
	            						<div class="admin__download-tickets-pending-ticket-key">
	            							#{msg.pi}:
	            						</div>
	            						<div class="admin__download-tickets-pending-ticket-value">
	            							#{ticket.pi}
	            						</div>
            						</div>
            						
            						<div class="admin__download-tickets-pending-ticket-key-value-wrapper">
	            						<div class="admin__download-tickets-pending-ticket-key">
	            							#{msg.title}:
	            						</div>
	            						<div class="admin__download-tickets-pending-ticket-value">
	            							#{ticket.title}
	            						</div>
            						</div>
            						
            						<div class="admin__download-tickets-pending-ticket-key-value-wrapper">
	            						<div class="admin__download-tickets-pending-ticket-key">
	            							#{msg.email}:
	            						</div>
	            						<div class="admin__download-tickets-pending-ticket-value">
	            							#{ticket.email}
	            						</div>
            						</div>
            						
            						<div class="admin__download-tickets-pending-ticket-key-value-wrapper">
	            						<div class="admin__download-tickets-pending-ticket-key">
	            							#{msg.message}:
	            						</div>
	            						<div class="admin__download-tickets-pending-ticket-value admin__download-tickets-pending-ticket-value-message-wrapper">
		            						<div class="admin__download-tickets-pending-ticket-value-message">
		            							#{ticket.requestMessage} 
		            						</div>
		            						<span class="admin__download-tickets-pending-ticket-unfold-button"><i class="fa fa-caret-right"></i></span>
	            						</div>
            						</div>
            						
            						<script>
            							// Check if download ticket request messsage is very long and offer unfold button
            							
            							$('.admin__download-tickets-pending-ticket-value-message-wrapper').each(function() {
    	            						if ($(this).height() > 74) {
    	            							
    	            							$(this).find('.admin__download-tickets-pending-ticket-unfold-button').fadeIn('fast');
    	            							$(this).find('.admin__download-tickets-pending-ticket-value-message').addClass('-unfoldable');
    	            							
    		            						$(this).on('click', function() {
    		            							$(this).find('.admin__download-tickets-pending-ticket-value-message').addClass('-unfolded');
    		            							$(this).find('.admin__download-tickets-pending-ticket-unfold-button').hide();
    		            						});
    	            						
    	            						
    	            						}
            								
            							});
            							

            						</script>
            						
            						
									<div class="admin__download-tickets-pending-ticket-actions">
				                     	<button class="btn btn--success"
				                     				data-target="ticketActivationButton"
			                                        data-require-confirmation="false"
			                                        data-confirmation-text="#{navigationHelper.getTranslationWithParamsUnescaped(msg.admin__download_tickets_activate_confirm, ticket.email, ticket.pi)}"
			                                        jsf:action="#{adminLicenseBean.activateDownloadTicketAction(ticket)}"
			                                        aria-label="#{msg.action__activate}: #{ticket.id}">
			                                        #{msg.action__activate}
			                            </button>
		                                <button class="btn btn--danger"
		                                            data-target="ticketRejectionButton"
		                                            data-require-confirmation="true"
		                                            data-confirmation-text="#{navigationHelper.getTranslationWithParamsUnescaped(msg.admin__download_tickets_reject_confirm, ticket.email, ticket.pi)}"
		                                            jsf:action="#{adminLicenseBean.rejectDownloadTicketAction(ticket)}"
		                                            aria-label="#{msg.activate}: #{ticket.id}">
		                                            #{msg.action__reject}
		                                </button>
	                                </div>

            						
            						</div>
            
            	</ui:repeat>
            
            

		            <ui:fragment rendered="#{ticket.request}">

		          	</ui:fragment>

	         	
	         	
	         	
	         	
	         	
	         	
            </div>
            

    </ui:fragment>
    
    

	<!-- DOWNLOAD TICKETS -->
	<!-- AK* rendered condition = show only if at least one active ticket -->
	<ui:fragment>
	
	<div class="admin__download-tickets-active-tickets-table-wrapper">

	    <h2>
	        #{msg.admin__download_tickets__active_download_tickets}
	    </h2>
	
		<div class="admin__table-tools">
			<!-- PAGINATOR -->
			<div class="admin__table-paginator">
				<viewerComponent:dataTablePaginator
					tableValues="#{adminLicenseBean.lazyModelDownloadTickets}" />
			</div>
			<!-- FILTER -->
			<div class="admin__table-filter">
				<viewerComponent:dataTableColumnFilter key="admin__clients__search"
					filter="#{adminLicenseBean.lazyModelDownloadTickets.getFilter('pi_email')}" />
			</div>
		</div>

		<div id="new-clients-table" class="admin__table-content" role="grid"
			aria-label="#{msg.admin__donwload_tickets__title}: #{msg.aria_label__table__actions}">
			<div class="row no-gutters admin__table-title" role="row">
				<div class="col-3 d-flex -sorting-arrow-trigger">
					<viewerComponent:sortingArrow filterType="pi_email"
						colHeading="#{msg.admin__download_tickets__pi}"
						list="#{adminClientsBean.configuredClientsModel}" />
				</div>

				<div class="col-5 d-flex -sorting-arrow-trigger">
					<viewerComponent:sortingArrow filterType="email"
						colHeading="#{msg.admin__download_tickets__title}" />
				</div>

				<div class="col-2 d-flex -sorting-arrow-trigger">
					<viewerComponent:sortingArrow filterType="dateRegistered"
						colHeading="#{msg.admin__download_tickets__email}"
						list="#{adminClientsBean.configuredClientsModel}" />
				</div>

				<div class="col-2 d-flex -sorting-arrow-trigger">
					<viewerComponent:sortingArrow filterType="dateLastAccess"
						colHeading="#{msg.admin__download_tickets__expires}"
						list="#{adminClientsBean.configuredClientsModel}" />
				</div>
			</div>

			<ui:repeat var="ticket"
				value="#{adminLicenseBean.lazyModelDownloadTickets.paginatorList}">
	            <ui:fragment rendered="#{!ticket.request}">
					<div class="row no-gutters admin__table-entry" role="row">
						<div class="col-3 d-flex">
							<div class="admin__table-data" role="gridcell">
								<!-- RECORD IDENTIFIER -->
								<span class="admin__table-name admin__clients-table-client-name">#{ticket.pi}</span>
	
								<!-- TABLE ENTRY ACTIONS (EDIT/DELETE) -->
								<div class="admin__table-actions-wrapper">
								    <!-- SHOW RECORD -->
	                                <a href="#{navigationHelper.metadataUrl}/#{ticket.pi}/1/" class="admin__table-action-link"
	                                    target="_blank" aria-label="#{msg.downloadTicket} #{msg.show} (#{ticket.pi}/1)">#{msg.show}</a>
									<!-- EXTEND -->
									<ui:fragment rendered="#{ticket.active or ticket.expired}">
	                                    <button class="admin__table-action-link"
	                                        data-require-confirmation="true"
	                                        data-confirmation-text="#{navigationHelper.getTranslationWithParamsUnescaped(msg.admin__download_tickets_extend_confirm, ticket.email, ticket.pi, '14')}"
	                                        jsf:action="#{adminLicenseBean.extendDownloadTicketAction(ticket)}"
	                                        aria-label="#{msg.extend}: #{ticket.id}">
	                                        #{msg.admin__download_tickets_extend}</button>
	                                </ui:fragment>
									<!-- RENEW -->
									<ui:fragment rendered="#{ticket.active}">
	                                    <button class="admin__table-action-link"
	                                        data-require-confirmation="true"
	                                        data-confirmation-text="#{navigationHelper.getTranslationWithParamsUnescaped(msg.admin__download_tickets_extend_confirm, ticket.email, ticket.pi)}"
	                                        jsf:action="#{adminLicenseBean.renewDownloadTicketAction(ticket)}"
	                                        aria-label="#{msg.extend}: #{ticket.id}">
	                                        #{msg.admin__download_tickets_renew}</button>
	                                </ui:fragment>
									<!-- DELETE -->
									<button class="admin__table-action-link -redlink"
										data-require-confirmation="true"
										data-confirmation-text="#{navigationHelper.getTranslationWithParamsUnescaped(msg.admin__download_tickets_delete_confirm, ticket.email, ticket.pi)}"
										jsf:action="#{adminLicenseBean.deleteDownloadTicketAction(ticket)}"
										aria-label="#{msg.delete}: #{ticket.id}">
										#{msg.delete}</button>
	
								</div>
							</div>
						</div>
	
						<div class="col-5 d-flex align-items-center" role="gridcell">
	<!-- 						<span class="admin__table-ip-address">#{client.subnetMask}</span> -->
														<!-- EMAIL -->
								<span>#{ticket.title}</span>
						</div>
						
						
						<div class="col-2 d-flex align-items-center" role="gridcell">
							<!-- RECORD TITLE -->
							<span class="admin__table-additional-info">#{ticket.email}</span>
						</div>
	
						<!-- REGISTERED DATE -->
						<div class="col-2 d-flex align-items-center" role="gridcell">
							<!-- EXPIRES -->
							<span> <h:outputText value="#{ticket.expirationDate}">
									<f:converter converterId="localDateTimeConverter" />
									<f:attribute name="pattern"
										value="#{navigationHelper.dateTimePattern}" />
								</h:outputText>
							</span>
						</div>
	
					</div>
				</ui:fragment>
			</ui:repeat>

			<script type="text/javascript">
				// Create no entries found message
				if ($('.admin__table-entry').length == 0) {
					$('.admin__table-content')
							.append(
									'<br/><p >#{msg.hitsZero}</p>');
										}
			</script>

		</div>
		</div>
	</ui:fragment>

</ui:composition>