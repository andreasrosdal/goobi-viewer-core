<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://xmlns.jcp.org/jsf/html"
	xmlns:f="http://xmlns.jcp.org/jsf/core"
	xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
	xmlns:o="http://omnifaces.org/ui"
	xmlns:viewerComponent="http://xmlns.jcp.org/jsf/composite/components"
	xmlns:adminWidget="http://xmlns.jcp.org/jsf/composite/admin/widgets"
	template="/resources/themes/#{navigationHelper.theme}/templateAdmin.html"
	xmlns:jsf="http://xmlns.jcp.org/jsf">

	<ui:define name="metadata">
		<f:metadata>
			<f:event type="preRenderView"
				listener="#{navigationHelper.setCurrentPageAdmin('adminMessageQueue')}" />
		</f:metadata>
	</ui:define>

	<ui:define name="content">
		<div id="adminAllUsers">
			<h:panelGroup rendered="#{userBean.admin}">
				<h:form id="adminAllUserForm" prependId="false">
					<div class="admin__title-bar">
						<!-- TITLE -->
						<h1 class="admin__title">#{msg.admin__tasks__title}</h1>

					</div>
					<o:socket channel="messageQueueState">
                        <f:ajax event="update" render="@form" />
                    </o:socket>

					<viewerComponent:adminBreadcrumbs />

					<div class="admin__content-inner-content">

						<div class="admin__info-text">#{msg.admin__tasks__info_text}</div>


						<ui:fragment rendered="#{messageQueueBean.queueContent.size() > 0}">
						
						<div class="admin__tasks-title-wrapper">
							<h2 class="admin__tasks-task-title">
								<h:outputText value="#{msg.admin__tasks__pending_tasks}" />
							</h2>
							<div class="admin__tasks-status">
								<!-- 							<div class="admin__tasks-icon-text">Status: #{messageQueueBean.paused ? 'stopped' : 'running'}</div> -->

								<div
									class="admin__tasks-icon-wrapper #{messageQueueBean.paused ? '-paused' : ''}"
									data-js-trigger="#{messageQueueBean.paused ? 'resumeRunningTasksButton' : 'pauseRunningTasksButton'}"
									title="#{msg.admin__tasks__resume_button_tooltip}"
									data-toggle="tooltip" data-placement="top" data-trigger="hover">
									<div class="admin__tasks-icon-loader"></div>
									<div class="admin__tasks-icon">
										<div data-target="playPauseMsgQueueToggle"
											class="admin__tasks-button-pause #{messageQueueBean.paused ? '-hidden' : '-active'}">
											<i class="fa fa-pause"></i>
										</div>
										<div data-target="playPauseMsgQueueToggle"
											class="admin__tasks-button-play #{messageQueueBean.paused ? '-active' : '-hidden'}">
											<i class="fa fa-play"></i>
										</div>
									</div>
								</div>
							</div>

							<a class="admin__tasks-icon-wrapper"
								title="#{msg.admin__tasks__clear_all_button_tooltip}"
								data-toggle="tooltip" data-placement="top" data-trigger="hover"
								jsf:action="#{messageQueueBean.clearQueue}" jsf:id="clearButton"
								data-require-confirmation="true"
								data-confirmation-text="#{msg.admin__tasks__clear_all_button_confirmation}"
								aria-label="#{msg.admin__tasks__clear_all_button_confirmation}">
								<div class="admin__tasks-clear-all"></div>
								<div class="admin__tasks-icon">
									<div
										class="admin__tasks-button-trash #{messageQueueBean.paused ? '-hidden' : '-active'}">
										<i class="fa fa-times"></i>
									</div>
								</div>
							</a>

						</div>


						<!-- TODO style buttons, increase in size, add tooltip, change color of active button -->
						<button jsf:action="#{messageQueueBean.pauseQueue}"
							jsf:id="pauseButton" data-target="pauseMsgQueueButton"
							class="btn">
							<i class="fa fa-pause"></i>
						</button>

						<button jsf:action="#{messageQueueBean.resumeQueue}"
							jsf:id="resumeMsgQueueButton" data-target="resumeMsgQueueButton"
							class="btn">
							<i class="fa fa-play"></i>
						</button>

						<!-- INDIVIDUAL ROWS -->
						<ui:repeat var="task" value="#{messageQueueBean.queueContent}">

							<div class="admin__boxed-entry">



								<h3 class="admin__tasks-task-title">
									<span class="admin__tasks-title-number"
										title="#{msg.admin__tasks__task_number_of_single_tasks}"
										data-toggle="tooltip" data-placement="top"
										data-trigger="hover"> <h:outputText
											value="#{task.value}" />
									</span>
									<h:outputText value="#{msg[task.key]}" />
								</h3>

								<div class="admin__tasks-task-details-wrapper"
									data-target="showAllSingleTasks">

									<div class="admin__tasks-task-details-column-heads">
										<div>Identifier</div>
										<div>Properties</div>
									</div>

									<ui:repeat var="msgqueueticket"
										value="#{messageQueueBean.getQueryMessages(task.key)}">

										<div class="admin__tasks-task-details-row">

											<div class="admin__tasks-task-details-row-entry">
												<h:outputText value="#{msgqueueticket.pi}" />
											</div>
											<div class="admin__tasks-task-details-row-entry">
												<ui:repeat var="prop"
													value="#{msgqueueticket.properties.keySet()}">
													<h:outputText
														value="#{prop}: #{msgqueueticket.properties[prop]} " />
													<br />
												</ui:repeat>
											</div>
											<div class="admin__tasks-task-details-row-entry">
												<button
													jsf:action="#{messageQueueBean.deleteMessage(msgqueueticket)}"
													class="btn admin__tasks-task-details-delete-button">
													<i class="fa fa-times" />
												</button>
											</div>

										</div>

									</ui:repeat>

								</div>

								<!-- ACTIONS -->
								<div class="row admin__boxed-entry-actions">
									<div class="col-3 d-flex">
										<!-- SHOW DETAILS -->
										<a href="#" data-js-trigger="showAllSingleTasks"
											class="admin__boxed-entry-actions-edit"
											aria-label="show all tasks"><span
											data-target="showOrHideTasks">#{msg.show}</span><span
											class="admin__tasks-task-details-all-tasks-hidden-button"
											data-target="showOrHideTasks">#{msg.hide}</span></a>

										<!-- DELETE THIS -->
										<button class="admin__boxed-entry-actions-delete -redlink"
											data-require-confirmation="true"
											data-confirmation-text="#{navigationHelper.getTranslationWithParamsUnescaped(msg.admin__tasks__delete_message_type_confirmation, task.key)}"
											jsf:action="#{messageQueueBean.removeMessagesFromQueue}"
											aria-label="#{msg.delete}: #{task.key}">
											#{msg.delete}</button>

									</div>
								</div>
							</div>
						</ui:repeat>
						
						</ui:fragment>


						<div class="admin__tasks-title-wrapper">
							<h2 class="admin__tasks-task-title">
								<h:outputText value="#{msg.admin__tasks__planned_tasks}" />
							</h2>

							<div class="admin__tasks-status">
								<!-- <div class="admin__tasks-icon-text">Status: #{messageQueueBean.paused ? 'stopped' : 'running'}</div> -->

								<div
									class="admin__tasks-icon-wrapper #{quartzBean.paused ? '-paused' : ''}"
									data-js-trigger="#{quartzBean.paused ? 'resumeQuartzButton' : 'pauseQuartzButton'}"
									title="#{msg.admin__tasks__resume_button_tooltip}"
									data-toggle="tooltip" data-placement="top" data-trigger="hover">
									<div class="admin__tasks-icon-loader"></div>
									<div class="admin__tasks-icon">
										<div data-target="playPauseQuartzToggle"
											class="admin__tasks-button-pause #{quartzBean.paused ? '-hidden' : '-active'}">
											<i class="fa fa-pause"></i>
										</div>
										<div data-target="playPauseQuartzToggle"
											class="admin__tasks-button-play #{quartzBean.paused ? '-active' : '-hidden'}">
											<i class="fa fa-play"></i>
										</div>
									</div>
								</div>
							</div>
						</div>

						<div class="admin__quartz">

							<button data-target="pauseQuartzButton"
								jsf:action="#{quartzBean.pauseAllJobs}" class="btn">
								<i class="fa fa-pause"></i>
							</button>

							<button data-target="resumeQuartzButton"
								jsf:action="#{quartzBean.resumeAllJobs}" class="btn">
								<i class="fa fa-play"></i>
							</button>

							<!-- show all active message types -->
							<div style="width: 100%;" id="new-table-adminallmessagetypes"
								class="admin__table-content" role="grid"
								aria-label="#{msg.admin__queue_types}: #{msg.aria_label__table__actions}">
								<!-- TITLE ROW -->
								<div class="row no-gutters admin__table-title" role="row">
									<!-- NAME COL -->
									<div class="col-3 d-flex">Name</div>
									<!-- LAST LOGIN COL -->
									<div class="col-3 d-flex">Group</div>
									<div class="col-2 d-flex">previousFireTime</div>
									<div class="col-2 d-flex">nextFireTime</div>
									<div class="col-2 d-flex">Turnus</div>

								</div>


								<!-- INDIVIDUAL ROWS -->
								<ui:repeat var="entry" value="#{quartzBean.activeJobs}">
									<div class="row no-gutters admin__table-entry admin__tasks-quartz-table-row #{entry.paused == true ? '-paused' : ''}" role="row">
										<div class="col-3 d-flex flex-column">
											
											<div class="admin__tasks-quartz-table-entry-name-wrapper" role="gridcell">
												
												
												<button jsf:action="#{quartzBean.pauseJob}" class="btn btn--clean">
													<i class="fa fa-pause" />
													<f:setPropertyActionListener
														target="#{quartzBean.quartzJobDetails}" value="#{entry}" />
												</button>
	
												<button jsf:action="#{quartzBean.resumeJob}" class="btn btn--clean">
													<i class="fa fa-play" />
													<f:setPropertyActionListener
														target="#{quartzBean.quartzJobDetails}" value="#{entry}" />
												</button>
												
												<h:outputText value="#{msg[entry.jobName]}" />
											</div>

											<div>
											<button jsf:action="#{quartzBean.triggerQuartzJob}"
												class="btn admin__table-action-link -bluelink">
												#{msg.admin__tasks__run_once_now}
												<f:setPropertyActionListener
													target="#{quartzBean.quartzJobDetails}" value="#{entry}" />
											</button>
											</div>

										</div>

										<div class="col-3 d-flex align-items-center" role="gridcell">
											<h:outputText value="#{entry.jobGroup}" />
										</div>

										<div class="col-2 d-flex align-items-center" role="gridcell">
											<h:outputText value="#{entry.previousFireTime}" />
										</div>
										<div class="col-2 d-flex align-items-center" role="gridcell">
											<h:outputText value="#{entry.nextFireTime}" />
										</div>

										<div
											class="col-2 d-flex align-items-center align-content-center flex-wrap"
											role="gridcell">

											
<!-- 											<h:outputText value="#{entry.cronExpression}" /> -->

											<h:outputText value="#{entry.humanReadableCronTime}" />




										</div>
									</div>
								</ui:repeat>
							</div>

						</div>



						<!--  history table -->

						<h:panelGroup id="history" layout="block"
							styleClass="message-history">

							<h2>
								<h:outputText value="#{msg.admin__tasks__history}" />
							</h2>
							<div class="admin__table-tools flex-wrap">
								<!-- PAGINATOR -->
								<div class="admin__table-paginator">
									<viewerComponent:dataTablePaginator
										tableValues="#{messageQueueBean.lazyModelViewerHistory}" />
								</div>
								<!-- FILTER -->
								<div class="admin__table-filter b-3 mb-sm-0">
										
										<!-- TODO: ADD FILTER FOR targetPI, TOO  -->
<!--                                         <viewerComponent:dataTableColumnFilter -->
<!--                                             key="admin__comment_search" -->
<!--                                             filter="#{messageQueueBean.lazyModelViewerHistory.getFilter('targetPI_body_campaign_dateCreated')}" /> -->
								</div>
							</div>


							<!-- TABLE -->
							<div id="messagesHistoryTable" class="admin__table-content"
								role="grid" aria-label="#{msg.messagesHistoryTable}">

								<!-- TITLE ROW -->
								<div class="row no-gutters admin__table-title" role="row">


									<div class="col-2 d-flex -sorting-arrow-trigger"
										role="columnheader">
										<h:outputText value="#{msg.admin__tasks__message_id}" />
									</div>
									<div class="col-2 d-flex -sorting-arrow-trigger"
										role="columnheader">
										<h:outputText value="#{msg.admin__tasks__message_type}" />
									</div>
									<div class="col-2 d-flex -sorting-arrow-trigger"
										role="columnheader">
										<h:outputText value="#{msg.admin__tasks__pi}" />
									</div>
									<div class="col-2 d-flex -sorting-arrow-trigger"
										role="columnheader">
										<h:outputText value="#{msg.admin__tasks__properties}" />
									</div>
									<div class="col-2 d-flex" role="columnheader">
										<h:outputText value="#{msg.admin__tasks__last_update}" />
									</div>
									<div class="col-1 d-flex" role="columnheader">
										<h:outputText value="#{msg.admin__tasks__status}" />
									</div>

									<div class="col-1 d-flex" role="columnheader">
										<h:outputText value="#{msg.admin__tasks__retries}" />
									</div>
								</div>

								<div class="user-comments__table-body" role="presentation">

									<!-- INDIVIDUAL ROWS -->
									<ui:repeat var="message"
										value="#{messageQueueBean.lazyModelViewerHistory.paginatorList}">
										<div
											class="row no-gutters admin__table-entry admin__tasks-table-row #{message.messageStatus != 'FINISH' ? '-error' : ''}"
											role="row">

											<div class="col-2 d-flex">
												<h:outputText value="#{message.messageId}" />
											</div>

											<div class="col-2 d-flex">
												<h:outputText value="#{msg[message.taskName]}" />
											</div>
											<div class="col-2 d-flex">
												<h:outputText value="#{message.pi}" />
											</div>
											<div class="col-2 d-flex">
												<ui:repeat var="entry"
													value="#{message.properties.entrySet().toArray()}">
													<h:outputText
														value="#{msg[entry.key]}: #{msg[entry.value]} " />
													<br />
												</ui:repeat>
											</div>
											<div class="col-2 d-flex">
												<h:outputText value="#{msg[message.lastUpdateTime]}" />
											</div>
											<div class="col-1 d-flex">
												<h:outputText value="#{msg[message.messageStatus]}" />
											</div>

											<div class="col-1 d-flex">
												<h:outputText value="#{message.retryCount}" />
											</div>
										</div>
									</ui:repeat>
								</div>

							</div>

						</h:panelGroup>

					</div>

				</h:form>
			</h:panelGroup>
		</div>
		<script>
     	// SCRIPT FOR MESSAGE QUEUE PAUSE/RESUME BUTTON FUNCTIONALITY
		$('[data-js-trigger="resumeRunningTasksButton"]').on('click', function() {
			$(this).toggleClass('-paused');
		    $('[ data-target="resumeMsgQueueButton"]').click();
		    $('[data-target="playPauseMsgQueueToggle"]').toggleClass('-hidden');
		});
		
		$('[data-js-trigger="pauseRunningTasksButton"]').on('click', function() {
			$(this).toggleClass('-paused');
			$(this).addClass('-stoppingStatus');
		    $('[ data-target="pauseMsgQueueButton"]').click();
		    $('[data-target="playPauseMsgQueueToggle"]').toggleClass('-hidden');
		});
		
// 		$('[data-js-trigger="clearAllButton"]').on('click', function() {
// 		    $('[ data-target="clearMsgQueueButton"]').click();
// 		});
		
		$('[data-js-trigger="showAllSingleTasks"]').on('click', function() {
			event.preventDefault();
		    $(this).closest('.admin__boxed-entry').find('[ data-target="showAllSingleTasks"]').slideToggle();
		    $(this).closest('.admin__boxed-entry').find('[ data-target="showOrHideTasks"]').toggle();
		});

		</script>



		<script>
     	// SCRIPT FOR QUARTZ PAUSE/RESUME BUTTON FUNCTIONALITY
			$('[data-js-trigger="resumeQuartzButton"]').on('click', function() {
				$(this).toggleClass('-paused');
 			    $('[ data-target="resumeQuartzButton"]').click();
			    $('[data-target="playPauseQuartzToggle"]').toggleClass('-hidden');
			});
			
			$('[data-js-trigger="pauseQuartzButton"]').on('click', function() {
				$(this).toggleClass('-paused');
				$(this).addClass('-stoppingStatus');
 			    $('[data-target="pauseQuartzButton"]').click();
			    $('[data-target="playPauseQuartzToggle"]').toggleClass('-hidden');
			});
		</script>


		<script type="text/javascript">
									var dataTableConfig = {
										dataTablePaginator : "#dataTablePaginator",
										txtField1 : "#txtMoveTo1",
										txtField2 : "#txtMoveTo2",
										totalCount : "#totalCount",
										reloadBtn : 'input[id*="cmdMoveTo"]',
									};

									viewerJS.dataTable.init(dataTableConfig);
								</script>
	</ui:define>

</ui:composition>
